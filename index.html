<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FlashChat Group Chat (P2P Host-Relay)</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #333;
    min-height: 100vh;
  }
  h2 {
    margin-bottom: 10px;
    color: #222;
  }
  .container {
    max-width: 550px;
    width: 100%;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.1);
    padding: 20px;
  }
  input[type="text"] {
    width: calc(100% - 24px);
    padding: 10px;
    font-size: 16px;
    margin-bottom: 12px;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus {
    border-color: #007bff;
    outline: none;
  }
  button {
    background: #007bff;
    border: none;
    color: white;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
    margin-bottom: 12px;
  }
  button:hover {
    background: #0056b3;
  }
  #chat {
    display: none;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
  }
  #log {
    border: 1px solid #ddd;
    border-radius: 8px;
    height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: #fafafa;
    margin-bottom: 12px;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  #message {
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1.8px solid #ccc;
    flex-grow: 1;
    margin-right: 10px;
  }
  .message-row {
    display: flex;
  }
  .sender {
    font-weight: 600;
    margin-right: 5px;
  }
  .input-row {
    display: flex;
    align-items: center;
  }
  .info {
    font-size: 13px;
    color: #555;
    margin-bottom: 12px;
  }
</style>
</head>
<body>
  <div class="container">
    <h2>FlashChat Group ðŸ’¬ - Host-Relay P2P Chat</h2>
    <div class="info">
      1. Enter or generate a <b>group code</b>.<br />
      2. One user clicks <b>Start Host</b> to host the group.<br />
      3. Others enter the same code and click <b>Join Group</b>.<br />
      4. Everyone can chat live; messages relay through the host.<br />
      5. Messages are lost on reload, no backend required.
    </div>
    <input id="groupCode" type="text" placeholder="Enter group code (e.g. funchat123)" />
    <button onclick="generateCode()">Generate Random Group Code</button>
    <button onclick="startHost()">Start Host</button>
    <button onclick="joinGroup()">Join Group</button>

    <div id="chat">
      <div id="log"></div>
      <div class="input-row">
        <input id="message" type="text" placeholder="Type a message..." onkeydown="if(event.key==='Enter'){send();}" />
        <button onclick="send()">Send</button>
      </div>
    </div>
  </div>

<script>
  let peer;
  let connections = {}; // for host: key=peerId, val=connection object
  let connToHost = null; // for clients, connection to host
  let isHost = false;
  let userId = null;

  function generateCode(length = 8) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let code = '';
    for(let i=0; i<length; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('groupCode').value = code;
    alert(`Your group code: ${code}\nShare this with friends to join!`);
  }

  function startHost() {
    const code = document.getElementById('groupCode').value.trim();
    if (!code) return alert("Enter or generate a group code first.");
    isHost = true;
    userId = code; // Host's peer ID is the group code

    peer = new Peer(userId);

    peer.on('open', id => {
      logSystem(`Host started with ID (group code): ${id}`);
      alert("Host started! Friends can join with the group code.");
      document.getElementById('chat').style.display = 'flex';
    });

    peer.on('connection', conn => {
      logSystem(`Peer connected: ${conn.peer}`);
      connections[conn.peer] = conn;

      // When data received from a client, relay to others + host log
      conn.on('data', data => {
        const messageObj = { from: conn.peer, text: data };
        logMessage(messageObj.from, messageObj.text);

        // Relay to all other peers except sender
        for (const peerId in connections) {
          if (peerId !== conn.peer) {
            connections[peerId].send(`${messageObj.from}: ${messageObj.text}`);
          }
        }
      });

      conn.on('close', () => {
        logSystem(`Peer disconnected: ${conn.peer}`);
        delete connections[conn.peer];
      });
    });

    peer.on('error', err => {
      alert('Host error: ' + err);
    });
  }

  function joinGroup() {
    const code = document.getElementById('groupCode').value.trim();
    if (!code) return alert("Enter group code to join.");
    if (isHost) return alert("You are already the host.");

    userId = generateRandomUserId();
    peer = new Peer(userId);

    peer.on('open', id => {
      logSystem(`Client started with ID: ${id}`);
      connToHost = peer.connect(code);

      connToHost.on('open', () => {
        logSystem(`Connected to host: ${code}`);
        document.getElementById('chat').style.display = 'flex';
      });

      connToHost.on('data', data => {
        // Host relays messages as plain strings prefixed by "sender: message"
        const splitIndex = data.indexOf(':');
        if(splitIndex !== -1){
          const from = data.substring(0, splitIndex);
          const text = data.substring(splitIndex + 1).trim();
          logMessage(from, text);
        } else {
          logMessage("Host", data);
        }
      });

      connToHost.on('close', () => {
        logSystem('Disconnected from host.');
        alert('Host disconnected or connection lost.');
        document.getElementById('chat').style.display = 'none';
      });

      connToHost.on('error', err => {
        alert('Connection error: ' + err);
      });
    });

    peer.on('error', err => {
      alert('Peer error: ' + err);
    });
  }

  function send() {
    const input = document.getElementById('message');
    const msg = input.value.trim();
    if (!msg) return;

    if (isHost) {
      // Host sends message to all connected peers AND logs it locally
      logMessage('You (Host)', msg);
      for (const peerId in connections) {
        connections[peerId].send(`Host: ${msg}`);
      }
    } else {
      // Client sends message to host
      if (!connToHost || connToHost.open === false) {
        alert("Not connected to host.");
        return;
      }
      connToHost.send(msg);
      logMessage('You', msg);
    }
    input.value = '';
    input.focus();
  }

  // Utility: logs chat messages
  function logMessage(sender, text) {
    const log = document.getElementById('log');
    const div = document.createElement('div');
    div.classList.add('message-row');
    div.innerHTML = `<span class="sender">${escapeHtml(sender)}:</span> <span>${escapeHtml(text)}</span>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // Utility: logs system info messages
  function logSystem(text) {
    const log = document.getElementById('log');
    const div = document.createElement('div');
    div.style.fontStyle = 'italic';
    div.style.color = '#888';
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // Utility: escape html for safe display
  function escapeHtml(text) {
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
  }

  // Utility: generate a random user ID for clients joining group
  function generateRandomUserId(length = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let id = 'user_';
    for(let i=0; i<length; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }
</script>
</body>
</html>
